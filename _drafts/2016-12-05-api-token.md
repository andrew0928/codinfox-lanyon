---
layout: post
title: "API Token 入門 - 土炮版本 JWT"
categories:
- "有的沒的"
tags: ["有的沒的"]
published: false
comments: true
redirect_from:
logo: /public/full-logo.jpg
---

兩個禮拜前，第一次當線上讀書會的講者，分享了我過去土炮 API Token 的經驗，同時藉由簡單的 POC 過程，讓大家
了解 API Token 的原理跟應用。這兩年 [JWT](https://jwt.io/) (Json Web Token) 當紅，但是跟幾個人聊了聊，
大都是停在 library 用的很熟練的階段，但是問到如何應用? 有無變通的應用方式就剩一半了，再問下去問知不知道
JWT 背後怎麼運作的? 若要實作有無辦法自己做一套? 就沒有了 XD

在開始之前，先聊一下我為何會想挑這個主題。從事軟體開發的行業，我一直覺的我這年代是很幸運的。比我還年長的，
大都經歷過寫組合語言，甚至是用卡片的年代。比我年輕的，才剛入行就要面對各種技術及 framework。比我年長的那一代，
過程大都在跟工具及技術奮鬥，能把心思花在解決 user 問題本身的比例不高。比我年輕的這一代，面臨太多 framework,
每個 framework 都是累積多少經驗跟智慧才堆積起來的結晶，能夠充分掌握怎麼 "使用" 就很了不起了，哪有時間等你
慢慢鑽研背後的原理?

所以我覺得我這年代是很幸運的，我經歷過軟體還不是這麼複雜難搞的年代，也經歷過 Java, C#, JavaScript 這些可以
讓我專心思考架構之美的程式語言。我碰過很多問題，當年都還沒有妥善的 framework 可以直接套用，因此或多或少
我都自己土炮過一些 framework, 包含 ORM (在 SQL2000 年代，實作 object > xml > database，外加 xml index), 
Content Server (自己處理 URL, 用自己的機制去 mapping file system), MVC 架構 (對，用 asp.net webform + 
url rewrite, 實作 MVC 架構) 等等，當然也包括這次的主題: API Token。

<!--more-->

這些土炮的過程跟經驗，其實價值不在於我當年寫的東西多好用 (現在都被熱門 framework 比下去了 T_T)。但是開發
的過程累積的 know how 是無價的。比如我土炮過 ORM，現在用別家的 ORM 我大概就能理解他的做法是什麼，這樣的
作法在那些地方會有限制等等。更重要的是，我的進入障礙變得很低，我不再需要去了解一堆背後的原理，我只剩下表面
的工具跟函式庫需要去熟悉而已。因為上手速度快，所以我有更多充足的時間去評估幾套類似的 framework, 能比其他人
更精確的挑出合用的技術。這些能力是擔任 architect 必備的啊，挑錯 framework, 你可能會害整個團隊浪費幾個人月
的精力..

這篇文章其實寫的很到位，完全寫到我心坎裡了，貼出來給大家參考參考

[土炮精神](http://www.ithome.com.tw/voice/99856), 王建興 2015/11/19

節錄文章最後一個段落，當作前言的結尾:

> *如果我們在軟體開發的領域裡，只做使用者，那麼，很多基礎的東西，我們會愈來愈陌生，甚至就失去把它們做出來的能力了。*  
>
> *自己把某個主題做了一次，即使做的沒有現成的那麼好、那麼強大，但是一些基礎的核心議題必然經歷過一輪，之後，即使只當使用者了，也會更了解這個主題。*  
>
> *而或者，這個「土炮」出來的產物，未來，得以繼續發展，而漸漸地，有了和其他產品分庭抗禮的實力。你能擁有自己土炮的實力之後，當現成的產物無法那麼貼切的滿足自己的需求，才有機會透過自己來滿足這些需求。*  




# API Token 原理說明

接下來就來重現當天線上讀書會的內容了。讀書會全程都有錄影 (1小時)，不想花一小時看得，可以
直接看 slideshare 的投影片，搭配 github 上面的 source code 一起服用。這些連結請到文章最後面就看的到。


## API Token 要解決的難題

首先先來看看，一般的網站開發，若碰到熱門的服務導向架構，你需要從 A 網站或服務取得的授權，再到 B 網站去使用
他的服務，同時 A B 兩個服務之間沒有辦法很有效率且即時的溝通時，如何解決兩個網站之間的信任問題? 尤其是在 internet
上，離開服務的範圍都是不安全的，你傳遞的資訊送到 client side (不論是 APP 或是 browser) 更是不安全，資安專家
有上百種的方式可以把你想隱藏的資訊挖出來破解...

舉個例子，如果 A 服務是付款，同時讓你取得遊戲點數，你可以去 B 服務訂購商品。B 服務寄出商品後會月底跟 A 服務商
收取貨款。這種情況下如果資訊的傳遞沒有保護好，client 在 A 付了 100 元，卻可以在 B 訂購 1000 元的商品，這樣你還
敢做生意嗎?

![API Token 要解決的難題](/wp-content/uploads/2016/12/apitoken-slides04.png)

簡單的用一張圖來代表這個情境，你必須想一個方式來確保這些資訊的傳遞是安全的，否則賠錢的生意絕對做不久的...

先來看看實體的世界怎麼解決問題? 大家應該都買過車票，我舉個類似的情境。你在 7-11 訂了張車票，也付款取票了。
當你要去車站搭車時，車站的驗票系統或是站長確認無誤，讓你進站搭車了。這時站長可能當場打電話給 7-11 確認這張
車票嗎? (Orz, 突然覺得我這例子有點蠢..) 當然不會這樣做。所以車站憑 "什麼" 確認這張票的正確性? 同時票上面
也註記了你的服務使用範圍，例如你可以搭 1/1 72車次 莒光號，從台北到花蓮站，座位是 9 車 16 號...

最基本的是車票本身有防偽造的設計，例如蓋章，雷射標籤，磁卡等等。這機制如果夠可靠，車站只需要檢查車票是不是
假的 (是不是真的從售票單位賣出來的?)，只需要確認上面標記的資訊有無被竄改 (台北到花蓮，有沒有被塗改?)。這些
資訊若都能簡單的驗證，那麼就可以省掉大幅的溝通成本，不需要跟 7-11 當場確認就可以讓乘客搭車了。


## RSA 數位簽章

當你把問題拆解成: B 要能驗證資訊是原封不動從 A 送出的，這問題其實就簡化很多了。關鍵技術就只有一個: 數位簽章。

講到密碼學，我想大家頭就開始痛了，我點到為止就好，我們常聽到的 RSA 加密，各位只要記得三個原則:

![RSA基本概念](/wp-content/uploads/2016/12/apitoken-slides05.png)

這原則你就暫時把它當作鐵律，別再去懷疑他了。他是有數學的原理在背後支持的，當這三條鐵律在有限的時間內不可能被
破解的話，我們能怎麼用它來解決問題?

講加密就太辛苦了，車票上的資訊不需要保密，總是要讓站務人員看得懂。我們只需要證明他是真的車票就夠了。答案是數位簽章。
在實體的世界裡，簽章是不能偽造的，所以你看到我的簽名就代表我看過這份文件。那數位世界的簽章怎麼做的?

![RSA基本概念-產生數位簽章](/wp-content/uploads/2016/12/apitoken-slides06.png)

Hash 是另一個必須要懂得技巧。你可以用特定演算法，把一連串的資料算出他的 Hash。如果原始資料改了一個 byte, 那
算出來的 Hash 就會完全不一樣。若不一樣的資料算出一樣的 Hash, 這就是 Hash 碰撞。好的演算法，很少會碰到碰撞的狀況。
尤其是原始資料看起來格式等等都正確，只是改了你想改的內容時，還能算出一樣的 Hash, 那機率更低。

數位簽章的原理就是拿原始資料的 Hash, 用你的 private key 算出簽章，附加在你的原始資料中，就是簽章過的資料了。



![RSA基本概念-驗證數位簽章](/wp-content/uploads/2016/12/apitoken-slides07.png)

由 A 送出的簽章過的資料，送到 B 手上，B 只要用相反的程序驗證就可以了。驗證的步驟是:

1. 分解出資料跟簽章兩部分
1. 將簽章 (加密過的 Hash) 用 public key 解密，可以還原出 Hash
1. 將 (1) 分解出的資料，自己重新計算一次 Hash #2
1. 比對 Hash 與 Hash #2，若兩者相同，則資訊安全無誤，是 A 送出來的內容沒有被竄改過

這麼神奇嗎? 沒錯! 這就是數學神奇的地方。搭配這簡單的應用，你就能確認手上的資訊是安全的了。即使在傳遞的過程
中被 1000 個 hacker 看光了，那也無所謂，這資訊沒被竄改就足夠了，不是嗎?




# API Token 實作 (土炮版)

好，故事講完，開始應用了。前面講的數位簽章能怎樣幫我們解決難題?

回到剛才的場景，當你通過帳號密碼等等各種驗證機制後，A 服務已經願意跟你交易了，你付了 100 元，A 產生了簽章過的 100 元
代幣給你，這就是 SESSION TOKEN。你可以憑著這 SESSION TOKEN 到 B 去使用，所有的帳都記在 A 的帳上。B 怎麼確認
A 同意你這樣做? 用上述流程驗證簽章過的 SESSION TOKEN 就可以了。

當然 A 能附加在 SESSION TOKEN 上的資訊不只是 "100元" 這麼簡單，你可以附加任何你想要的資訊上去，只要最後記得
正確地完成簽章程序就好了。

該怎麼做? 開始來看 code 了。其實這些做法我大約一年前有三篇文章講過了，這邊我摘要的說明就好。為了簡化簽章跟驗證的程序，
我設計了簡單的 ```TokenData``` 與 ```TokenHelper``` 兩個類別。TokenData 用來存放 Token 本身的資料，他會被 Json 
的 library 進行 serialization / deserialization。TokenHelper則是做編碼及解碼動作用的工具類別。

直接來看 code:











用起來很簡單，在 A 的部分 (請參考 AUTH 這個 project) 這樣使用，可以得到一串 SessionToken 字串:






在 B 只要這樣還原 SessionToken 物件，沒有產生任何 Exception 就算驗證成功:






好，這麼一來你可以不用擔心 SessionToken 的內容被亂改了。裡面標記的資訊都是可以信賴的，不需要懷疑他。
這個例子我是舉遊樂場的例子，AUTH 代表售票口，使用者透過 API TOKEN 認證通過後，就可以取得 SESSION TOKEN。
裡面註記了使用期限 (ExpireDate), 你的名字 (UserID)，還有 A 對你的註記 (標籤 Tags)。這些


API 專案則代表遊樂場，他會依據你的 SESSION TOKEN，確認無誤且沒有過期的話，就提供遊樂設施給你使用。隨著
Tags 註記的不同，你能夠享用的設施層級也不同。被標記為 VIP 則可無限次使用 (骰骰子可骰無限次)。若被標記為
奧客 (BAD) 則只能骰五次。沒有特別標記就是一般會員，最多可以骰 10 次。

各位可以自己試看看，你也許可以還原 SESSION 的內容，但是除非你有拿到 A 的 private key, 否則你再怎麼樣
也無法產生你想要的 SESSION TOKEN 內容。就算只是想從已產生的 SESSION TOKEN 去把 BAD 改為 VIP 也沒辦法。
因為你改不動簽章的部分。一但你改了原始資訊，簽章還原的 Hash 還是修改前的 Hash, 而 B 重新計算的 Hash #2
則是修改後的 Hash, 演算法告訴我們這樣的情況下 Hash 會不同，造假的 SESSION TOKEN 就被揪出來了。





# 延伸應用

其實，看似很困難的密碼學，搞懂原理後其實還蠻實用的。



## 如何防止 Reply Attack ?


## Public Key / Private Key 的用法


## 應用在軟體授權序號


## 雲端大量佈署服務的授權控制














# Reference

線上讀書會錄影:
<iframe src="https://www.facebook.com/plugins/video.php?href=https%3A%2F%2Fwww.facebook.com%2Fandrew.blog.0928%2Fvideos%2F345280552513896%2F&show_text=0&width=560" width="560" height="315" style="border:none;overflow:hidden" scrolling="no" frameborder="0" allowTransparency="true" allowFullScreen="true"></iframe>

SlideShare:
<iframe src="//www.slideshare.net/slideshow/embed_code/key/KtCTtyKgN5r20n" width="595" height="485" frameborder="0" marginwidth="0" marginheight="0" scrolling="no" style="border:1px solid #CCC; border-width:1px; margin-bottom:5px; max-width: 100%;" allowfullscreen> </iframe> <div style="margin-bottom:5px"> <strong> <a href="//www.slideshare.net/chickenwu/api-token" title="API Token 入門" target="_blank">API Token 入門</a> </strong> from <strong><a target="_blank" href="//www.slideshare.net/chickenwu">Andrew Wu</a></strong> </div>

http://www.slideshare.net/chickenwu/api-token?qid=7bd09d0a-587f-4ed6-826d-d12c71f0b252&v&b&from_search=1


GitHub:
https://github.com/andrew0928/MeetUp.ApiTokenDemo


WHY 自己土炮?






