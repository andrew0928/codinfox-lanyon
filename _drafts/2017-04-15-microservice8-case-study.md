---
layout: post
title: "架構師觀點 - Case Study"
categories:
- "系列文章: .NET + Windows Container, 微服務架構設計"
- "系列文章: 架構師觀點"
tags: ["microservice", "系列文章", "ASP.NET", "架構師", "Docker", "Windows Container"]
published: false
comments: true
redirect_from:
logo: 
---

微服務這系列的文章暫停了三個月，不是沒興趣寫了，而是這幾個月都在 "還債" + "充電"，換了另一種形式在產出分享內容，同時
也花了些時間累積微服務的基礎建設研究及評估經驗。我想分享的都是實際的開發及導入經驗，如果沒實際做過是寫不出來的.. 因此才暫停
文章的寫作計畫一陣子。

這幾個月，工作的方向做了些轉變，不變的是我仍然在 .NET & 微服務架構開發與導入這領域努力。在這陣子，幾個單位
也不約而同的找我分享這些內容，因此就 microservices & windows containers 這領域，有這幾場現場的演講 & 互動:

1. [DevOps Taipei](https://www.facebook.com/groups/DevOpsTaiwan/?fref=ts), [這一夜讓我們來聊聊 Microservices](http://devops.kktix.cc/events/meetup4-cm-tools-96091c-b7dd89)
> http://blog.chengweichen.com/2017/02/devops-taiwan-meetup-4.html

微服務的架構與觀念，以及導入時要留意的陷阱。導入微服務架構，最重要的是了解微服務能解決你現有的那些問題，最忌諱的就是一窩蜂的
改寫 + 擁抱新技術，這樣會得不償失。這個 session 則是我親身執行過的案例經驗分享。

1. [Study4.TW](https://www.facebook.com/Study4.tw/?fref=ts), [Visual Studio Everywhere 台北場](http://study4-tw.kktix.cc/events/study4devtaipei)
> https://www.facebook.com/pg/Study4.tw/photos/?tab=album&album_id=1263376603748230

專注在 .NET 開發人員，為甚麼一定要關注 windows container 這項技術? 容器化的部署方式，已經是大家關注的焦點了。
也被認定是要落實 DevOps 的必要技術之一。不過身為 .NET 開發人員，總覺得 container 技術離 .NET 還很遙遠，因為
目前主流的容器化應用，都還是在 linux 平台上面的 docker. windows container 在去年年底推出，讓 .NET 開發人員也開始
有機會接觸容器化的部署技術了。這個 session 則是針對 .NET 開發人員的 windows container 介紹及 demo 。

1. [TibaMe](), 線上課程

windows container 入門，與 docker / microservice 的背景介紹。課程要傳遞的概念與 VS Everywhere 的那場一樣，只是
形式是以線上課程 (video) 為主。總時數約 6 hr, 因此在觀念，架構以及實作 Labs 講得比較仔細。


1. [TibaMe](), 線上讀書會

windows container 入門，以及實際的開發 / 部署 demo。包含 windows container, hyper-v container, docker-compose
這是 TibaMe 配合線上課程安排的推廣活動之一，因此內容也是線上課程的延伸。時間只有一個小時，因此我把重點擺在觀念介紹 (15min)，
而保留大部分時間在操作及 demo, 同時也保留了 20min 給現場在線上的朋友們提問及討論。希望藉著線上互動的方式，解決自己在看
影片或是文章時，無法搞清楚的一些細節及觀念問題。




四個場子的屬性都不大一樣，每場講的都是 .NET + Microservices + Windows Container, 只不過重點擺的地方都不同。
每場講完都覺得有點缺憾，有些重點沒時間帶到。我還是擅長用寫的啊，寫下來的東西總是比用講的精確。因此我就補了這篇文章，
希望把這四個場次的分享重點都串起來。沒機會參加前面幾場的朋友們，可以看這篇文章；有參加過的朋友也可以看看文章，補上了
我沒機會在現場提到的重點。

<!--more-->

{% include series-2016-microservice.md %}


--

## 本文開始

1. "微服務" 是什麼?

先寫在前面，微服務只是個架構的設計參考方向，他並不是個 "問題"，也不應該是個 "目標"，他只是解決某些問題的 "方法"。因此，
若你不清楚你面對的是什麼問題，也不清楚你期望的目標是什麼，就只因為聽到微服務很棒，就要毅然決然地把整套系統砍掉重練，改成
微服務架構，那是很不切實際的。錯誤的決定，很有可能拖垮整個團隊。因此說明清楚這些前因後果，就是我這個段落主要的目的。

我先簡單的對 "微服務" 下個定義吧。字面上來說，就是把單體式的系統 (monolitch), 拆解成多個獨立的小服務, 再靠 API 把彼此
串聯起來的架構，就是 "微服務" 了。

微服務會變熱門，基本 (理想的) 概念就是: 現今軟體的複雜度越來越高，越大型的軟體，維護的成本是呈指數上升的。一個規模是 N 倍的軟體，維護
成本可能是 N^2 .. 若把它拆成 N 個獨立的服務，那麼維護的成本就變成線性的 N 倍了..

不過別忘了，微服務本身就是個分散式系統，分散式系統有它先天的複雜度，包含網路通訊不可靠，要維持資料的一致性就是個考驗，加上
跨服務的 bug 追查難度更高等等，都是個挑戰，都會讓維護的成本上升。

貼一下我在 DevOps #4 這場分享的幾張投影片:

![](2017-05-02-01-09-54.png)

就上面講的特性，我把常見的幾個關鍵字抓出來了。如果你對這些微服務的設計 guideline 有興趣，那右邊那本書很推薦，值得一讀。

![](2017-05-02-01-10-05.png)

![](2017-05-02-01-11-51.png)

這兩張投影片，我想表達的是同一件事，就是你的商業邏輯，到底要按照什麼樣的法則來切割才洽當? 整個微服務架構導入的過程中，我認為
最困難的就是這點了。這才是關鍵啊! 在談論這點之前，先來看看有那些部分是技術上 "適合" 切割的?

若你檢視你的系統架構，發現有明顯的系統邊界 (如上圖)，有某些模組之間有很複雜的連結 (高內聚)，某些模組之間的關聯則很鬆散 (低耦合)，
那麼這些地方就是技術上適合切割微服務的點。問題是，只要有這種狀況，都是適合切割的地方嗎?

答案是否定的。這是很容易犯的錯誤，別說是新手了，連我都踩進這個陷阱好幾次。很多時候，技術導向的團隊，很容易把一切決策都導向到
技術角度來判斷。我問這個問題很明顯是個陷阱，真正的狀況應該是: 你要評估切割之後，是否有解決你的問題? 康威定律提到一點，系統的架構
會跟組織的架構有高度相關，你的組織怎麼分工的，也會連帶影響到你的系統架構設計。這裡就是一例，你應該回頭檢視，切割之後是否你的系統
架構，會更貼近你組織的運作方式? 如果答案是肯定的，這樣的切割才會對你的整體運作有幫助。

其實這不是新課題，只是因為微服務，這些議題被放大重新拿出來討論罷了。在 DevOps #4 這個場子，我提了一個觀點，也是我過去廿年來一直有的
想法。其實軟體工程講求的原則一直都沒變啊! 我永遠記得當年大學時代，我初次接觸 C++ 也初次接觸物件導向技術時，當時我的啟蒙書籍就是那本
知名的 "世紀末軟體革命"。裡面講到很重要的一點，物件導向就是在 "模擬世界、加以處理"。

這句話我到現在都還記得，因為這就是物件導向之所以能解決問題的核心概念啊! 不知各位有沒有想過，為何我們總是在抱怨客戶或是老闆改規格，
客戶嘴上說把某個按鈕拿掉，我們背後的程式碼架構就得整個翻掉? 但是總是有些厲害的團隊，就是能很快的反應客戶的需求? 我想關鍵就在於
你的系統架構有沒有跟真實的流程做對應。

使用者會認為改個按鈕很簡單，因為他的想法會建構在不改變他的流程為前提，所以他會認為改個按鈕是很容易的事情。系統能不能對應很簡單的做出
改變，關鍵就在於系統的流程跟實際的流程有多貼近了。如果你有按照 OOP 的核心概念 "模擬世界，加以處理" 來設計的話，實際處理過程中會碰到的
人、系統，傳遞的資訊，接受訊息後的反應等等，都有一一的在程式碼裡面做對應，那改變就會真的很容易。

同樣的道理，OOP 講的是在單一軟體系統架構內，你程式碼組織的方式。把這個想法擴大到整個分散式系統，那麼原本 OOP 講的 object / class, 
不就也對應的擴大到 microservices 了嗎? 如果你的服務與服務之間的架構，能跟組織裡的運作邏輯一一對應的話，那這架構就是適合你的架構。

我很常做的一件事，就是拿 UML use case diagram (雖然這是老技術了，不過你能用的透徹的話還是很好用的)，拿來跟我的微服務架構圖來對照。
如果設計得當的話，兩張圖應該是能夠對應得起來的。因此，該怎麼切割? 應該先從這個觀點來看才對! 如果架構上適合，技術上也容易執行，那是
最完美的狀況了，沒什麼好考慮的了。

若是流程上適合切割的地方，技術上卻有不少困難，那代表背後的架構跟實際的組織流程並沒有很好的對應。這時不要急著做微服務的切割 (這就是
我一直說的本末倒置)，而是先將系統重構到合理的狀況後，再來進行切割。

看到這邊，你有掉進這個問題的陷阱嗎?




