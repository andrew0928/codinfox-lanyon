---
layout: post
title: "水電工日誌 7. 事隔 12 年的家用網路架構大翻新"
categories:
- "系列文章: 水電工日誌"
tags: ["水電工", "有的沒有的"]
published: true
comments: true
redirect_from:
logo: /wp-content/images/2019-12-12-home-networking/network.jpg
---

![](/wp-content/images/2019-12-12-home-networking/network.jpg)

好久不見的 "水電工日誌" 又出現了 !

自從 12 年前，家裡重新整修了一番，花了不少時間把家裡的區域網路弄起來後，就再也沒花功夫去搞他了，只能說在家裡先佈好足夠的網路線，還有一個可靠的機櫃真是好用啊 (果然是阿宅的夢想)。不過四個多月前，一次台電計畫性的停電，就把我家的 router 跟 switch 搞掛了, 雖然 router 兩天後莫名其妙的又活起來, 但是終究壽命已盡, 撐到一個月前雙十一前夕又掛了, 再也救不起來...

事後發現，停電根本不是真正的原因啊 (我有 UPS, 又有事先主動關機...), 根本原因就是裡面的電容都鼓起來了, 單純關機就再也開不起來而已... 雖然掛掉的 router 被蘇老妙手回春救回來, 不過我替他安排好退休生活了, 趁著雙十一敗家合理 (其實根本沒優惠啊啊啊) 的氛圍下，我把家裡的網路設備都換了一輪了... Orz

這次替換，主要有兩大目的，其一是我要換掉困擾我很久的 WiFi 網路連線問題；另一個就是網路的基礎設備 router / switch 的規劃問題。前面那系列水電工日誌，已經是 12 年前。當年的重點在從無到有，都在弄佈線等等施工的問題，網路的架構 (其實當時也不懂) 只要設備正常能動能上網就好了。當時甚至沒用啥路由器，還是自己架 server, 插上兩張網卡自己弄軟體的 NAT server ...

這次趁著 "天災" ，折損了一些設備，不得不正面面對這些問題了，剛好就半推半就，把看了很久的設備買進來。辛苦摸索了近一個月，總算搞定了 (所以才會有這篇文章)。許久不見的水電工日誌，就這樣重返江湖了 :D



# 敗家有理 #1, UniFi AP

其他網路設備，大概都只能算是我自己愛玩才弄的，但是 WiFi 不一樣啊，只要訊號不好或是斷線連不上，全家人就會跑來問我為什麼不能連... 先前服役的設備是 7 年前 (2012) 買的 ASUS RT-N16, 這台大家都是買來刷機用的, 原廠 firmware 你用到會想丟掉他, 換上第三方韌體就變成神器了。我家的格局一台 WiFi 搞不定，所以後來又添購了第二台 小米 WiFi Mini ...

一台 RT-N16 只有 2.4GHz, 另一台雖然有 2.4GHz / 5GHz, 不過 LAN 只有 100Mbps (加上是對岸的網路設備...), 加上沒有 Mesh, 走到另一個區域就要自己切換 SSID, 否則可能還黏在訊號很弱的那台, 不會自動切換到訊號強的那台...。

其實我早就物色好要換哪台了啊! 只是一直缺臨門一腳敗下去... 直到這次老天爺給我製造了這個機會 (咦?   笑想很久的小藍圈: UniFi-AP AC Lite 兩台就一次給他買下去了.. 

![](/wp-content/images/2019-12-12-home-networking/2019-12-12-21-53-00.jpg)

這牌子的 AP, 用過的就知道了, 我就不勸敗了, 用過就知道好用, 我只買兩台算客氣了。這其實是企業用的 AP, 從一開始設計就是為了讓你大規模部署用的。你可以在同一個空間，買好幾台共同提供同樣的 SSID 連線, 背後靠他的 unifi controller 統一控制, 簡單用滑鼠設定一下就會自動部署到每一台 AP ...。也因為他設計就是服務大規模的無線上網環境用，因此自動漫遊是基本功能；控制軟體很好用，加上吸頂的造型設計, 支援 PoE (Power over Ethernet, 透過網路線供電), 連線又穩定, 訊號也棒, 用過就回不去了。鄉民都說這牌子的設備會自體繁殖，只要你買了一台，過一陣子就會越買越多...

![](/wp-content/images/2019-12-12-home-networking/unifi-ap-aclite.jpg)

至於他的控制軟體 UniFi Controller 也是個好物, 他不只是遠端設定你的 AP, 而是替你管理你整套的 networking, 只要你願意整套都買它們家的 (Wireless AP, Internet Gateway, Switch ... etc), 所以會越買越多不是沒原因的, 不過我... 財力有限, 就忍住了, UniFi 沒有買到全家餐, 就兩台 AP 而已... 

![](/wp-content/images/2019-12-12-home-networking/2019-12-12-22-19-41.png)

這 UniFi Controller 軟體需要另外安裝 (不然你就要花錢買硬體) 對有些人來說是個缺點, 因為你要另外找電腦安裝才能用... 還好他有 docker 的版本, 我直接裝在 NAS 上就沒事了 (這軟體要安裝 Java, 實在不想在 PC 上面裝這個...)

![](/wp-content/images/2019-12-12-home-networking/2019-12-12-22-35-45.png)


# 敗家有理 #2, Router + Switch

前面提到的退役設備: ASUS RT-N16, 其實這七年間扮演過不少角色, 一開始是扮演 AP 沒錯, 但是他的訊號實在不怎麼樣, 反而刷機之後 router 本身的穩定性跟效能都是一時之選, 刷特定 firmware 還能開啟 hardware NAT, 因此有一陣子他的天線都被我拔掉，關進機櫃專心負責 router 的角色了。從此之後, 我就再也不用那種 WiFi + Router 的機種了。WiFi 更新的很快，兩三年就有新規格出現，但是貴的部分都在 Router 身上啊 (管理軟體，CPU，RAM ...), 為了升級無線部分的規格就要整台換掉，不但浪費而且也很麻煩 (整個設定都要重來)... 因此我從一開始就不愛用這種多合一的設備，從以前開始就自架 server 當作 NAT + DNS ..., 後來換 RT-N16 刷機, 接著換了 RouterOS (MikroTik RB450G) 的設備, 這次則是換了 Ubiquiti EdgeRouter-X SFP...

![](/wp-content/images/2019-12-12-home-networking/2019-12-12-23-10-49.jpg)

其實，就功能而言，RouterOS 的機種，比 EdgeRouter 系列的好的多，網路上找的到的資源也比較多。不過會換掉的原因很簡單，一個是支援 PoE, 我的 AP 就可以省掉一個變壓器；另一個是溫度低, 先前的 RB450G 運作中會燙到拿不起來... (電容大概就是這樣爆掉的), 最後一根稻草, 就是他的 WebUI 比較合我胃口 (雖然功能很陽春, 進階一點的功能都得自己下 CLI)

![](/wp-content/images/2019-12-12-home-networking/2019-12-12-23-13-28.png)

好啦，其實沒有什麼非換不可的理由 (上面的理由都很牽強)，就是想換新設備而已... 這次掛掉 router + 24 ports switch, 當然也要買一組新的回來... router 前面介紹過, switch 我則是挑了 Netgear GS116E 這台支援網管的 16 ports GBE switch...

原本壞掉的是 Belkin 24ports GBE switch, 我估計也是電容爆掉了 (我就沒去修了)，幾年前買的都是無網管的機種，碰到 MOD 就無解了，要區隔 NAS 有獨立的網段也無解... 趁這次壞掉要換新的，我就直接挑選有網管的機種了，最主要的目的就是要切 VLAN 啊! 雖然當年家裡重新拉水電管線時，我預埋了一堆資訊插座，埋到竟然要買到 24 ports 才夠用，不過牆上雖然有那麼多孔，不過固定會用到的 ports 其實沒那麼多 (現在都無線化了，雖然我不是那麼喜歡無線) ... 因此我就挑了台尺寸迷你的 16 ports 機種，為了節省空間，我也不買機架型的了，買桌上型的放在機櫃...


![](/wp-content/images/2019-12-12-home-networking/2019-12-12-23-16-01.jpg)
測試中的 EdgeRouter-X SFP (上) 與 Netgear GS116E (下)

# 敗家有理 #3, (亂入) Intel i350-T4

這個真的是亂入的 XDD, 這是前陣子換 PC, 各方考量挑了最適合的主機板: ASUS TUF GAMING X570-PLUS (WI-FI) ... 這張主機板什麼都好，就是敗在他的內建網路晶片不是我慣用的 Intel ... (雖然 onboard 的晶片也沒強到哪裡去)。不過 intel 的網路晶片好處之一就是各種 OS 都內建啊! 有些虛擬化或是 server 端的軟體支持度就是比較好一點, 身為架構師應該換張網路卡也是很合理的... 於是網拍看到一張狀況不錯的 Intel i350-T4, 有四個 ports, 就豪不考慮的敗下去...

![](/wp-content/images/2019-12-12-home-networking/2019-12-12-23-35-10.jpg)
(2019/09 購入的 Intel i350-T4 server 用 4 ports GBE 網卡)


# 網路規劃 - 切割 VLAN

曬完設備, 開始來聊點頭痛的... 前面的東西都是想完之後捏一下就敗下去了，但是東西買回家之後才是惡夢的開始啊! 想到當年我買 MikroTik RB450G 回來時也是搞了整整一個禮拜才能上線... 這次也差不多，不過這次工程浩大一點，如果加上 AP 弄好到安裝在天花板上，前前後後我也花了近一個月才通通搞定... Orz

![](/wp-content/images/2019-12-12-home-networking/2019-12-12-23-27-12.jpg)
(2015/03 購入的 MikroTik RB450G)

我先列一下，我期望新的網路環境能夠搞定這幾件事:

1. 我希望 server(s) 能有專屬網段
1. 我希望 WiFi AP 能直接用網路線供電 (PoE)
1. 我希望關鍵的線路能直接接在 router 上
1. 我希望我的 PC 能接到 switch 直接 PPPoE 撥接上網測試
1. 我希望我的 NAS 可以 LAGP 合併頻寬

其實要是設備沒燒掉的話，我應該會再多撐兩年再更換的，到時再直接升級到 10GBE 網路... 不過我對頻寬需求沒那麼高，現在對外網路也只停留在光世代 100M/40M 沒再升級上去了。網路穩定可靠架構單純 對我來說還更重要一點。上面幾點需求，有幾點彼此是有點難搞，我對網路其實沒那麼熟，很多東西其實也是這個月自己摸索出來的...

上面的需求 (1), (2), (3) 其實不難, 挑一台合適的 router 就可以搞定 (我就是這樣才挑 EdgeRouter-X SFP), 既然是 router, 切個網段不會是個問題, 這台雖然是低階機種, 但是仗著 SoC 支援多種 hardware offloading, 效能也還不錯，對我來說綽綽有餘。(4), (5) 則是找台支援 VLAN 的 switch 應該也可以搞定。不過, WiFi 要接在 router 上啊, 對網管不熟的我, 就是這次才真的搞懂 VLAN 怎麼弄, 花了些時間研究, 才把 router 上的 AP 跟 switch 上的 7 ~ 16 ports 設定在同一個區往 (VLAN) 內。


我期望的網路架構 (邏輯) 應該長這樣:

![](/wp-content/images/2019-12-12-home-networking/2019-12-13-01-38-06.png)



然而，實際的配線, 因為 router / switch 的 ports 都有限, 因此我希望能這樣架設:

![](/wp-content/images/2019-12-12-home-networking/2019-12-13-02-06-43.png)

VLAN 我用顏色區分，我希望 switch 上面的 16 個 ports, 以及 router 上面的 5 個 ports, 我都能靈活分配。Router 至少一定要一條線接到 VDSL Modem, 也至少要一條線接到 switch, 除此之外，我希望剩下的 ports 都能夠有效利用。UniFi AP 因為需要 PoE 的關係, 也要直連到 router 的 port, 其他設備都按照架構圖, 直接連到 switch 上。

原本我只知道 VLAN 是幹嘛用的，但是完全搞不懂怎麼設定，我還以為圖中 router 接到 switch 那條三色線, 是真的要用掉 router / switch 各三個 ports 才辦的到 (果然是門外漢)，後來花了些時間研究 VLAN 怎麼設定，才發現原來可以讓三條線併成一條啊!

還好我買對機器，EdgeRouter-X SFP 屬於較低階的機種，但是反而 ports 給比較多，因為他用的是 MediaTek 的 SoC, 本身就整合了 switch 的功能在裡面，所以這台 router 可以視為內建 switch 的機種，切割 VLAN 不需要靠 bridge 來設定, 用 switch 的硬體處理起來會更快速。本來我在這邊卡了很久，想不通 bridge, routing table, 還有 vlan ID 到底怎麼指派才對，後來我把 EdgeRouter 想像成 router + switch 來設定就成功了。

細節我就不多說，總之是把 router 的 5 ports 都先當成 switch, 然後切割出三個 VLAN 的 interface, 然後再分別設定 PPPoE, Server LAN, Home LAN 該有的 dial up, static routing, DHCP server, DNS forward, firewall rules 等等。同時另外一台 switch 的部分也按照 VLAN 正確設定每個 ports 的 tag / untag 的 VLAN ID, 最後就是這張圖呈現的樣子了。

這不是程式碼，而且我也不夠熟練，我就不獻醜貼我自己的設定了，有興趣的朋友可以直接透過 facebook 跟我討論 XDD，最後補張最後完工的上機櫃照片


![](/wp-content/images/2019-12-12-home-networking/2019-12-12-23-23-47.jpg)

正好我的 PC 換上 Intel i350-T4 網卡, 有 4 ports 可以用 (根本用不完啊), 常常需要測些有的沒有的，能夠按照我需要隨時 PPPoE 直接取得對外 IP 就再方便也不過了。因此我直接很奢侈的接了兩條網路線，一條 Home LAN, 一條 Modem LAN, 測試 PPPoE 撥接上網完全沒問題，我只要動動滑鼠就夠了! 其實仔細想想，Server 用的網路卡應該也有能力在單一 port 上指定 VLAN ID, 搞不好我還有機會進一步把這兩條線再合併成一條 (就像那條 router 接到 switch 的多色線一樣的道理)，不過搞到這邊已經快超過我腦袋的負荷了，決定到此為止。


# 實測效能

我這邊就不花功夫去測試頻寬了，直接單純的從 NAS 拉大檔案來測看看就好。測試的大檔 (別想歪，不是迷片) 就拿我 .NET Conf 2019 兩場演講的錄影檔來測試，攝影機加上電腦螢幕錄製，前後總共 2hr 的影片總共 XX GB, 中間經過 router 轉發 (沒有經過 NAT)，可以跑出接近極限的 950 Mbps...





# 後記




















# BACKUP



寫在前面:

其實我對網管是個大外行，出社會後就一直從事軟體開發的工作 (雖然大學念的是通訊領域的科系) ... 會想自己在家架設網路，純粹是阿宅的天性使然，單純想享受在家裡自己蓋起我理想中的網路環境 (就是自嗨) 的成就感而已。除了成就感之外，另一個很重要的原因，就是我往往都可以在網路設備上，找到解決問題的靈感。

靈感? 應該這麼說，網路設備算是硬體，但是要解決的都是很複雜的網路環境需求，尤其是路由器或是防火牆這類的設備。我常在想，為什麼面對複雜的問題 (每間公司的網路環境其實落差都很大)，為何網路設備都有這麼高的適應能力? 雖然都有很複雜的設定，但是受過訓練的網管總是有辦法正確的設定，解決各種複雜的網路環境需求。我想其中一部分的道理，就是這些問題，都被歸納出很一致的規則，例如 VLAN 就是 package + tag 的應用, router 就是各種 routing table / firewall policy 的組合...。

由於這些複雜的問題已經被梳理成背後一些網通產業的 "領域知識"，因此設備廠商只要時做這些 "領域知識" 的管理介面，訓練有素的網管就能把整個環境蓋起來。我在面對一些其他應用程式的複雜問題時，往往能從這些做法中找到一些靈感，例如利用 rules + priority 的組合, 就能取代大量的開關設定。