---
layout: post
title: "設計案例: 命令列工具開發技巧 - 串流處理 & PIPELINE"
categories:
tags: []
published: true
comments: true
redirect_from:
logo: 
---

最近工作上碰到個案子，其中需要開發 CLI (Command Line Interface) 的工具。其實這本來是件不起眼的小事，不過如果你平常不常用 shell script (其實我也不熟啊 @@), 或是其他 CLI tools 的話，要你決定 CLI 該怎麼被使用，應該一時間也不知道該怎麼辦吧!

我把主軸拉回 "串流資料" 的處理方式吧。會需要用到 CLI 不外乎幾個原因，例如:

1. 這個操作必須被自動化或是重複執行，寫成 CLI 才方便放在 shell script 執行。
1. 這個操作需要處理大量資料，或是需要長時間執行，不需要 GUI 介面的時候。
1. 需要跨語言開發，直接做成 CLI 方便跨異質開發環境呼叫。
1. 發展自己的 CLI toolset, 讓 shell script 能夠組合使用。

為了搞定這幾件事情，你的 CLI 可不是 "能動" 就好了。你提供的操作方式 (參數，輸入輸出的設計) 會直接影響你寫的 CLI 用起來順不順手。我這篇就特別針對 CLI 之間的資料交換，還有大量資料交換的串流處理方式介紹一下好了。我相信很多後端的工程師都碰過這種場景，只是過去你可能沒留意到就用別的方式處理掉了。看完這篇文章，可以仔細想想，重新來一次的話是否有更好的設計方式。

<!--more-->



# 概念: 串流處理的基本概念

從 2000 年那個年代，"串流" 就開始變成熱門關鍵字了。當時頻寬不如現在快速，下載檔案沒有等個半小時以上是跑不完的，尤其是處理 VIDEO 更是如此，因此串流處理技術就被大量運用普及了。所謂的 "串流處理"，講白話一點就是:

> 下載一部份，就處理 (播放) 一部份。處理完一部份就輸出一部份，下一關就可以接手處理這一部分的片段資料。

好處很明顯，你不需要等所有的資料傳輸完畢才能開始處理 (尤其是傳輸或是 I/O 很花時間的時候)；如果整個任務，還有好幾關的話，善用串流處理的技巧，你很快就會開始得到處理的成果。整個過程就像工廠的生產線一般，開工了每隔幾秒鐘就有一輛車子製造完成... 只要整座工廠持續運作，過程中你可以很穩定的不斷收到成品。

其實這種概念，我當年寫的那一堆多執行續處理技巧的文章，其中講到 PIPELINE 的部分就是這概念。當時強調的是把工作拆成很多個階段，每一小塊 job 就用多執行緒的技巧，一步一步往下傳，就像郵局寄信一樣，一個人負責裝信封，一個人負責封口，一個人負責貼郵票，每一關做完把半成品交給下一關就好。

我會在最前面先講這概念的原因就是，串流處理的特性，是把資料切成很多小塊，每次處理完就交給下一關，你就不需要等到所有的資料都處理完第一關後才能交給第二關接手。當資料量很大時，你可以拿到第一筆結果的時間可以從 O(n) 降為 O(1), 資料量越大這差異越大。另一個隱含的差異，間接的你需要暫存這些半成品的儲存空間 (可能是 memory, 或是 disk) 也從 O(n) 降為 O(1) 了。

如果你是後端工程師，那你更必須在意這個技巧。你不只需要會 "使用"，你還要有能力 "開發"。試想你如果接到客戶的資料需要轉檔，如果你的工具都能符合前言的四點特性，你的工作會更有效率 (快點往下看吧 XD)

舉個現實的例子: 直播。你能想像沒有串流的情況下，你還有可能看到直播嗎? 沒串流的話只能這樣:

1. 錄影
1. 轉檔
1. 上線

網紅只能對著鏡頭自己講話 30 min, 然後等 30 ~ 60 min 轉檔，再等 10 min 上傳發布, 然後其他網友才能看到影片... 




# CLI 的串流處理介面: STDIN / STDOUT / STDERR

# PIPELINE

# JSONL (Json Line)

# 結論