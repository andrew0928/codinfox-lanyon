---
layout: post
title: "[架構師的修練] #2, SLO - 如何確保服務水準? "
categories:
- "系列文章: 架構師的修練"
tags: ["系列文章", "架構師的修練", "刻意練習"]
published: false
comments_disqus: false
comments_facebook: false
comments_gitalk: true
redirect_from:
logo: 
---

繼 [上一篇]() 講完整個我對技術人員職涯要持續成長，就必須要刻意的持續練習看法後，這篇我就來舉更深入的案例吧。你累積的經驗或是能力，若無法轉換為價值，那是沒有用的。技術人能展現的價值，就是解決問題。怎樣才能讓一個問題拿到你面前你都能迎刃而解? 最有用的就是如何將你累積的經驗能力串起來的連結。連結越強，織起來的知識網就越強韌，你看問題就會越到位。

這篇我就拿我在去年 91APP TechDay 以及 .NET Conf 2020 Taipei 都分享過的主題: SLO 來當例子吧。這是近年來我擔任架構師，端出來的幾個 solution 之中，對於 "連結" 這件事最有代表性的案例了。要解決這問題，你不但要有很札實的技術及實作能力、也要有很到位的 cloud infrastructure 掌控能力，同時還要具備管理知識，缺一不可，才有可能把這件事情解的漂亮。表面上看來，訂定服務水準要達成的目標 (SLO, Service Level Objective) 並落實，是個很純粹的技術題目啊，但是真正做過的人就知道，只靠技術能力硬拚，總是缺了點什麼，沒有辦法做到盡善盡美。我自己的心得是，越複雜的問題 (即使是系統問題)，你越需要從管理的角度去思考怎麼解決他 (當然最後還是要寫成 code)。

<!--more-->

往下的探討，我都會圍繞著這主題: 非同步系統的服務水準保證。這邊所謂的 "非同步系統"，你就想像成是我們內部開發的類似 FaaS (Function As A Service) 的服務，各個產品線都有一些需要非同步執行的任務 (Task), 往我們的這套系統丟；我們這套系統就要想辦法盡快安排資源，來將這些任務喚醒執行。這些任務每天都有上百萬個等著被執行，每個都期待要 ASAP, 偏偏這些任務又不完全是我們團隊開發的，於是就開始有各種矛盾出現... 別人寫的 code 卻要我們來確保他會在保證的時間內執行完畢。

如果你也覺得這事件不可能的任務，那恭喜你，你已經開始可以理解這個問題的困難點了。請繼續看下去 XDD


# 前言: 確認要解決的問題是什麼?

雖然這篇是把我演講的內容寫成文章，但是演講有時間限制，可能大家沒耐性聽我講一堆故事...。不過這是我的部落格，我想寫一些我想寫的...。我想要把演講當下沒辦法交代清楚的脈絡一起寫出來交代清楚，這樣才能前後連貫的說明我思考的脈絡。前面這段 [前言]，算是問題的背景，我花點時間交代一下...

前面講過 FaaS, 我相信用過 Azure Functions, 或是 AWS Lambda 等服務，大概都能想像吧。我們期待讓 developer 能無腦的只管把任務 create 建立起來往後端丟，之後就等著執行完畢拿結果回來就好。好處很多，最主要的是不必阻塞 (block) 前端的回應，間接的也節省很多不必要的等待跟鎖死資源。透過 message queue 來管理這些任務，就能提高可靠度，同時我們也能更容易的調節後端的運算資源，提高使用率。在雲端的世界裡，提高使用率就代表你能用更少的 instance 做同樣的事情，成本自然就會降低。

不過所有事情都有正反兩面啊! 我隨便舉就有一堆:

1. 使用率越高，代表空閒的機器越少，越難應付突發的需求；一旦發生瞬間流量，可能會導致部分任務需要等待更多時間才能得到執行結果。
1. 承 (1), 多準備一些運算資源 (多開機器) 當然可以解決，但是這樣也讓成本上升
1. 每個任務的特性都不同，有的一瞬間結束，有的一跑就是幾分鐘；有的吃 CPU，有的吃 IO，有的吃 Memory ..., 擺在一起容易互相干擾，分開擺使用率就難以拉高。
1. 有些任務需要保證時間內執行，有些不需要。混再一起會加大管理與監控負擔，同樣的分開則難以拉高使用率
...

相信有設計過大型的系統，對於這些矛盾都很熟悉吧? 我就點到為止，直接進入今天的主題。如果我的任務都有定義服務水準的期待 (SLO)，我該怎麼達成它? 系統的規模越大，分工就越細，單一任務可能涵蓋的團隊也有好幾個，當我的 task 無法在期待的時間內執行完畢，原因太多了，有可能 task 寫的太爛 (需要 optimize), 也有可能排程的系統 (orchestration) 寫的太爛, 也有可能是機器開的太少或是等級太低, 也有可能是客戶上傳了太多資料, 也有可能是網站的使用者太多, 或是突然面臨 DDOS 攻擊...

問題想到這邊，我開始意會到，光是把 code 按照規格寫好，把效能調教好是不夠的 (即使這件事我做到 100 分也一樣)。我必須多做點什麼，搭配額外的手段 (不管是技術還是非技術手段) 才有可能。所以我才聯想到過去的一些管理技巧，並且思考將他們應用在系統上...。





