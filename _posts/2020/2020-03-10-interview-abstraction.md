---
layout: post
title: "架構面試題 - 抽象化設計, 折扣規則的設計機制"
categories:
tags: ["系列文章", "架構師", "C#"]
published: false
comments: true
redirect_from:
logo: 
---

最近看到好幾篇有內容的討論串，都提到 "抽象化思考" 是個很關鍵的能力。我就在想 "什麼才是正確的抽象化思考" 案例? 看了很多講理論的文章，也看了很多[定義](https://zh.wikipedia.org/wiki/%E6%8A%BD%E8%B1%A1%E5%8C%96), 我相信很多人還是一樣有看沒有懂，或是你真的理解抽象化的概念了，但是真正應用在工作上，你也不一定用的到位啊! 於是就有了寫這篇文章的念頭。我一樣不喜歡只講 "理論"，理論說的容易，要落實才是最難的那一步，因此我決定拿個工作上的案例來說明 "抽象化" 的概念。

我就拿我在面試架構師常問的問題之一: 折扣機制的設計方式當作這篇文章的主題吧! 只要做過銷售網站，或是相關的系統，我相信一定都被這個主題弄得牙癢癢的，你想的再週全，客戶就是會想出你意料不到的折扣規則來折磨你...。不過，這是個很好的例子啊，正好拿來驗證你的抽象化思考夠不夠到位。該說是職業病嗎? 從開始學寫 code 後，我就習慣在日常生活中，碰到大小事情，我都會在腦袋裡想一下 "這東西我該怎麼寫 code 來處理?" ...，就是這個折扣計算的問題，每次我在收銀機等結帳時就在想:

> 這個第二件六折的折扣我該怎麼去計算?

> 這個第二件加一元我該怎麼設定才合理?

> 這個即期品半價優惠的機制我該怎麼處理，POS 機才能搞的定?

> 這麼多種折扣混在一起，收銀機怎麼用一致的規則來處理才不會算錯?

這些問題我就這樣，在我腦袋裡面轉過好幾次了 XDD (所以一時之間想不出來的朋友們不用難過)。我就用這篇文章的篇幅來說明一下該如何將這問題抽象化，然後一步一步解決現在跟未來的問題。

<!--more-->

雖然這篇是 "架構面試題"，不過我也是把他歸類在 "微服務架構" 系列文章之內。原因很簡單，所謂的 "抽象化"，就是將事物的共通或是概念的部分 "抽離" 出來，丟開複雜的實作細節，只留下抽象的概念部分的過程。這除了是思考解決問題的重要過程之外，也是思考各種 interface 的關鍵啊! 只要跟 interface 扯上關係的技術，都跟抽象畫能力有直接關聯。例如 code 如何定義 interface ? 你的 code 要解藕, 就需要分離 interface 跟 implementation, 透過 DI 注入跟解析的機制來達成解藕的目的；你的服務如何定義 API (API: Application Programming **I**nterface), 對微服務如何切割，最關鍵的就是 service boundary, 這邊界的實作，通常也會是某種 API, 或是 message contract. 總而言之，抽象化是一切解決複雜度的基本概念，當然也包括微服務的架構設計。


# 問題: 折扣機制到底有多難搞?

直接來看問題吧! 這次我不自己想題目了，我直接跟現成的 DM 來取材。什麼東西的折扣機制最複雜? 我想就以超市為首選了 XDD, 我逛了逛最近很紅的全聯超市，從他的官網首頁隨便挑幾個折扣的促銷資訊，同時在底下先標上我自己的註記:


> ![](/wp-content/images/2020-03-10-interview-abstraction/2020-03-10-00-58-41.png)  
> NOTE: 指定商品 (衛生紙) 一次買 6 捲便宜 100 元

> ![](/wp-content/images/2020-03-10-interview-abstraction/2020-03-10-01-01-03.png)  
> NOTE: 指定商品 (蘋果) 單粒 23 元， 4 粒 88 元


> ![](/wp-content/images/2020-03-10-interview-abstraction/2020-03-10-01-03-15.png)  
> NOTE: 指定商品 (雞湯塊) 單盒特價 145 元，第二件 5 折


> ![](/wp-content/images/2020-03-10-interview-abstraction/2020-03-10-01-04-36.png)  
> NOTE: 指定商品 (沐浴乳) 買一送一


其他還有更複雜的，除了折扣外還送點數，或是你搭配點數可以折抵部分金額等等的玩法，這篇就不討論了 (再講我就透漏太多商業機密了 XDD)，我單純只談論 "折扣" 的部分就好。

大部分的 developer, 碰到這類的問題，第一個浮現的解法就是 "歸納" 法。簡單的說，就是把上面我寫的 NOTE，同樣句型的歸成一類，黑字的部分變成參數，就搞定了。展示用的 POC code 後面再補，這麼一來，上面的規則大概就被我規成四類了。每類寫一段計算折扣的邏輯就搞定了。我想大部分靠 coding 維生的人應該都不成問題。



接下來玩大一點，換一家店看看... 這次我們看全家便利商店:

> ![](/wp-content/images/2020-03-10-interview-abstraction/2020-03-10-01-15-06.png)  
> NOTE: 指定商品 2 件 + 49 元送杯套一個


> ![](/wp-content/images/2020-03-10-interview-abstraction/2020-03-10-01-16-09.png)  
> NOTE: 指定商品 同商品 加 10 元多 1 件


> ![](/wp-content/images/2020-03-10-interview-abstraction/2020-03-10-01-17-23.png)  
> NOTE: 指定商品 任選兩件 第二件 6 折，不同價格以兩件 8 折計算


有發現嗎? 這些規則，乍看都跟上面的差不多，但是仔細想一下卻又有一點點出入... 舉例來說，同商品第二件六折，跟任選兩件八折就有點不同... 買一送一，也跟第二件免費 (0折) 不同，一個是直接送你，一個是你要自己拿進購物車啊...

頭開始痛了嗎? 還沒結束... 超商還愛玩一種: 早餐 + 飲料 這種...

> ![](/wp-content/images/2020-03-10-interview-abstraction/2020-03-10-01-30-14.png)  
> NOTE: 指定鮮食 + 指定飲料 特價 ( 39元, 49元, 59元 )

再來一個:


> ![](/wp-content/images/2020-03-10-interview-abstraction/2020-03-10-01-31-25.png)  
> NOTE: 任選主餐 + 指定副餐 折 5 元


真是夠了，台灣的零售業者，就是有辦法想出你意料之外的折扣規則 XDD ... 你會發現，光靠 "歸納" 法，你已經無法應付 "未來" 的問題了，你只能從 "過去" 的需求來歸納出幾種做法，並且參數化。算算看，上面列舉的這些折扣，你需要歸納成幾種優惠? 每種優惠說他不同，但是又感覺好像都差不多... 那麼你需要維護多少種 code ? 如果再來個致命一擊，每種規則又有區分會員價跟非會員的話...


# 抽象化的第一步: 隱藏細節、提取重點

好了，別再打擊各位了，例子我就舉到這邊就好 (你想知道的話還有更多變態的折扣規則可以聊)。我們回到這篇的主題: 抽象化。

先來看看抽象化的定義，很多定義都太生硬了，我比較喜歡這篇的說法:

> 「隱藏細節、提取重點」可以說是抽象化的核心精神。
https://medium.com/orangeapple/%E9%81%8B%E7%AE%97%E6%80%9D%E7%B6%AD%E7%9A%84%E6%A0%B8%E5%BF%83-%E6%8A%BD%E8%B1%A1%E5%8C%96-c7e013f30c6

不過，折扣機制的重點又是什麼?

繼續之前，容我再岔題一下。我們來聊聊 OOP 的三大權杖之一: 封裝 (Encapsulation)

如果跟我一樣，有點年紀的 developer, 大概都經歷過 C / C++ 那個 ADT (Abstract Data Type) 的年代吧! 這裡的 封裝 跟 抽象化，其實是一體兩面。你如果把細節 "封裝" 起來，最後呈現出來的只剩下重點，就是抽象化。把他套用在你要描述的物件或是資料上，創造出來的 class, 那麼就是所謂的 "抽象資料型別" (ADT)。

為什麼說 OOP 有三大權杖? 這三大權杖分別是: 繼承 (Inheritence), 封裝 (Encapsulation), 多型 (Polymorphism)... 當你要封裝一個資料類型，你會把細節隱藏在內部。當你有多個資料類型要封裝，你會開始把重複的部分題取出來，這一般化 (generalization) 的動作就是繼承。如果都有繼承關係，那麼就可以用 is-a 的關係去看待他，從共同的類別衍生出來的類別都可以當成父類別看待，可以用一至的型別來看待他。不同類別的物件，都被當成同樣父類別的物件看待，而每個物件卻都能有各自不同的行為表現，這就是多型。

額外穿插這 OOP 的說明，就是要讓大家知道，抽象化做的到位，OOP 的三大權杖你就應該也掌握的到位了。後續的應用就可以非常靈活的變化。相對的你如果覺得抽象化之後用的卡卡的，那請回頭重新思考，你的抽象化是否真的有做到「隱藏細節、提取重點」?

別太在意對錯，這種思考題目是沒有對錯的。會發生的狀況是，你隱藏的細節，不是你解決的問題需要的；你提取的重點，也剛好不是你要解決的問題的重點；如此而以，只是適不適合的差別。因此要是覺得不對勁，請回頭重新想想。


OK，再次回到我們的主題: 折扣機制。折扣機制的 "重點" 到底應該是什麼? 你該隱藏的 "細節" 又是什麼? 前面說到，你抽象化封裝應該要對齊你要解決的問題才對。來看看上面舉的這麼多案例，你要解決最 "頭痛" 的問題是什麼?

為了方便複習，我把這些折扣規則的 NOTE 列在一起方便思考:







我的答案是: 我想隱藏的細節是 "計算規則"，因為每種折扣的規則都不大一樣，對我而言那是很煩人的事情，我真正在意，而且也是每個折扣規則一定會有的結果，就是最終的折扣金額。這是我唯一在意的重點: "結帳後的折扣" 。

我進一步描述我的想法，如果我把每個折扣規則，都想像成一個黑盒子，裡面放著折扣的規則，我不需要了解他的細節，我只要把籃子裡的商品，每項都交給規則計算，規則只要告訴我，計算後我可以得到多少折扣，然後從總金額 (原價) 裡扣除就好了。

