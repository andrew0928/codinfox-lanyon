---
layout: post
title: "架構師觀點 - 轉移到微服務架構的經驗分享 (Part 3)"
categories:
- "系列文章: .NET + Windows Container, 微服務架構設計"
- "系列文章: 架構師觀點"
tags: ["microservice", "系列文章", "ASP.NET", "架構師", "Docker", "Windows Container", "DevOps"]
published: true
comments: true
redirect_from:
logo: /wp-content/uploads/2017/05/
---

前面兩篇，分別介紹了微服務架構的規劃方向，還有實際切割的案例探討。這篇 (Part 3) 的重點就要擺在微服務到底該在甚麼樣的基礎建設上面
運行? 維運過去單體式架構的 application, 所需要的基礎建設，會跟微服務架構下可能會有數十個 service instances 同時執行，甚至上百個
service instances 一樣嗎?

我只能說，考量完全不一樣!! 微服務架構簡化了服務本身的複雜度 (每個服務變小了，責任也變單一)，但是整體的 application 並沒有變簡單啊，
因此複雜度都轉移到服務與服務之間。因此要能妥善管理及維護好眾多的服務 instances 能彼此順利的合作，是個不小的挑戰。這邊最主要的關鍵，
就在於底層的基礎建設了! 這篇就花點篇幅來聊聊這個部分: 微服務架構的基礎建設與部署。

<!--more-->

{% include series-2016-microservice.md %}


--

# 微服務需要那些基礎建設?

由於微服務架構下，服務與服務之間的關係變複雜了，基礎建設要解決的問題也跟著複雜。基礎建設的優劣，直接影響到整個系統的運作。
很多人認為，新創的公司或是新創的團隊，直接導入微服務就好了啊! 其實這不見得是最好的方式。想要一次到位的話，規模不夠大
可能還支撐不起這樣的基礎建設的維運；你的系統可能也還沒有大到需要靠微服務架構來支撐。我認為比較好的方式是漸進式，先從單體式架構
開始，但是要不斷地重構，隨時維持軟體本身的架構是優良的，隨時做好下一步切割為微服務的準備；在成長面臨瓶頸時，逐步的切割擴大，
自然而然的就會演變成微服務架構了，這時就是同步擴充基礎建設的好時機。

因此，若你身為架構師或是 CTO，必須替團隊做好長遠規劃時，了解將來需要什麼樣的基礎建設是必要的。這篇文章就來聊聊這個部分~
我先直接排除所有系統都需要的共通設備 (如防火牆，Load Balancer 這類的)，就針對微服務必備的基礎設施:

* API Gateway
* Service Discovery
* Communication & Event-Driven System
> orchestration vs choreography, sync vs async, event-driven
* Log

![](2017-06-18-01-41-32.png)

簡單的話張圖，順序我就由外到內來談吧。微服務對外提供的主要都是各種服務的 API，因此對外的第一個關卡就是 API Gateway. 
想像一下，這些 API 的背後若都是由幾百個微服務所組合而成的，你如何叫外面的系統各自呼叫到正確的微服務? 因此需要有個
良好的 API 代理機制來負責。

細節後面再談，API Gateway 大致上可以解決這幾件事:

1. 身分認證
1. API 路由 (routing)
1. API 聚合 (aggration)
1. API 流量管控 (throttle)

接著是 Service Discovery。既然我們都把整套系統切割成眾多微小的個別服務了。隨便就有上百個服務實體，隨時停掉幾個 instance
更新或是擴張等等異動是很平常的。那麼這麼多 service instance 的資訊該如何維護與管理? 這就是 service discovery 要扮演的
角色了。基本的模式就是有個 service registry 的機制，只要每個服務啟動了，第一件事就是跟他報告，其他人就能找的到正確的定位
服務。為了維護這清單的正確性，自然也有一些 healthy check 的機制。

實際上的狀況，DNS 已經可以負責處理大部分的 service discovery 需求。不過當然也有更進階更精準的解決方案。

再來就是微服務最關鍵的通訊機制了。這可以說是微服務的核心了。通訊永遠是最關鍵的一環，他影響了整套系統內每個服務與服務之間的
溝通方式。最簡單的是點對點的通訊 (如: Socket, HTTP/REST 等等), 發布/訂閱, 同步/非同步, Req/Resp 或是 Event Driven 等等
都是可能的通訊方式。

即使你用最基本的 HTTP/REST, 也是需要 Reverse Proxy / Load Balancer 之類的基礎建設。需要可靠的通訊時，Message Queue 變成
不可或缺的一環。

最後的 Log, 也是必須考量的一個基礎建設。除了典型的 Log 之外，我另外提一點: 跨越服務的紀錄追蹤。我舉個很常見的例子，快遞往往
有很多收發站，你送件之後就可以拿到 tracking number, 之後你就可以靠這個 tracking number 追查你的貨物到底送到哪裡了? 系統的
處理也是一樣，當一件事情拆成好幾個服務分別解決時 (別忘了，每個服務可能都還有上百個 instance ...), 出問題時你如何能從 Log
追查出這些問題所在? 如果你還是把 Log 當成每個 service 自己的日誌流水帳看待的話，碰到這種問題應該會一個頭兩個大。

這些就是導入微服務架構前，我認為應該要先評估好的基礎環境建設必要的幾個項目。
在逐一深入介紹之前，我先大力推薦這本 Nginx 的電子書給大家看:

![](/wp-content/uploads/2017/06/2017-06-06-02-07-00.png)
[Microservices: From Design to Deployment, a Free Ebook from NGINX](https://www.nginx.com/blog/microservices-from-design-to-deployment-ebook-nginx/)

會推薦這本電子書的的原因，主要是它的內容長度，內容深度跟講解的複雜度，都拿捏得剛剛好。沒有深入到太多實作細節，也沒有
淺顯到空談一堆你看完還是不知道怎麼做，更重要的是份量也剛好，只有 70 頁，薄薄的一本 (咦? 電子書有厚度嗎?) 不需要花很多
時間就能看完。這 ebook 介紹了微服務系統中幾個關鍵的基礎建設，以及為何需要它的原因，推薦大家都先去看一下這本書的內容。

想看網頁版也有.. 當初還沒出電子書時，我就是看網頁版連載的文章:
[Introduction to Microservices](https://www.nginx.com/blog/introduction-to-microservices/)

----


在這份電子書裡面，提到跟 microservices infrastructure 有關的有這幾個部分:

* API Gateway
* IPC (Inter-Process Communication)
* Service Discovery
* Event-Driven

除此之外，我另外追加一個我認為很重要的部分:

* Logs & Tracking

這幾個關鍵元件服務，被歸類在微服務架構的基礎建設之中。原因無他，因為只要你使用了微服務架構的概念來設計整套系統架構的話，
有些問題你是一定會碰到的。而這些基礎建設就是解決這些問題的最佳 solution. 

整體來看，API Gateway 扮演的就是 API 對外的關卡，你可以把他跟反向代理 (Reverse Proxy) 做個對比。反向代理主要用途，是
用來發行內部的 "網站"，在這過程中反向代理有時也會身兼 load balancer, waf (web application firewall) 等等角色來兼顧
安全，效能，擴充性與架構調整的彈性等等；而 API Gateway 則是用來發行內部的 "API"，也有一樣的目的與功能。

跨服務的通訊，也是個大問題。雖然微服務的特色之一是允許技術的異質性 - 每個服務互相獨立，可以個別採用最適合的技術，不需要
彼此限制。但是互相通訊的時候就需要統一了。這部分就牽涉到通訊的機制了。一般最常見的就是 HTTP + REST + JSON，可以提供同步 (SYNC)
的 API 呼叫。但是若你需要更複雜且可靠度更高的通訊機制，則需要採用 Message Queue 或是 Message Bus 這類的基礎建設了。
一個良好的 Message Bus 可以解決你很多可靠的通訊問題，包含提供非同步 (ASYNC) 的通訊模式，這點我們後面再探討。

通訊及提供服務的模式，除了同步 (SYNC) 與非同步 (ASYNC) 之外，從另一個角度來分類，則是被動呼叫與主動執行兩種。WEB 就是
典型的被動呼叫模式，你的 API 放在那邊等著人家來呼叫就是一例。但是有些時候，你的服務必須在沒有外面的系統呼叫 API 時執行。
最常見的就是定期執行的任務，或是某些重複執行，長時間執行等等任務都屬這種。

因此，進入實作微服務架構的第一件事，不是捲起袖子開始寫 code, 而是先把你需要的基礎建設與開發環境搭建起來。即使是基礎建設，
它們也維持跟微服務一樣的準則，簡單，只負責一件事，自主運作。不過，除非你很清楚知道你自己要做什麼，否則我強烈建議不要自己
動手開發基礎建設的服務，盡可能地採用成熟穩定可靠的 solution 才是上策。因此這段我主要的目的，是介紹每類基礎建設的服務是要
解決那些問題，而非你怎麼操作或是安裝他們。只有知道這些東西存在的目的，你才能做出最正確的判斷與選擇 (該挑選哪一套?
還是要自己開發? 該如何評估?)。

其他講微服務架構與觀念的，還有如何重構既有的 application, 我們在前面兩篇其實都帶到了，這裡就針對基礎建設來探討。
基礎建設通常也是某個(微)服務，用來解決多個微服務互相協同合作必要的基礎。例如通訊、代理、服務註冊語組態管理等等。



API Gateway 可以替整套系統統一解決掉認證問題，後面的每個服務就不再需要逐一確認呼叫者的身分，可以直接針對身分做授權的管控
即可。其他如API 呼叫次數的管控，API 呼叫的日誌等等都可以由 API Gateway 統一處理。但是最重要的，我認為是這兩項: aggration & routing。

Routing 是第一件最關鍵的任務，他可以把外面的 API 呼叫，引導到內部適合的服務接手處理。這個 routing 的機制能解決很多衍生的問題，
包括版本 (例如: 新舊版本的 client 呼叫同一組 API 需要提供不同的服務)，負載平衡與服務註冊 (例如: 需要將 API call 引導到 loading
較低的服務端點，或是引導到狀態良好沒有當掉或停機維護的端點)。這部份很多現成的服務可以選擇，可以找 API Gateway, 或是 API Management
這些關鍵字，可以找到不少資訊。

另一個關鍵的功能就是 Call Aggration。


## API Gateway

不論你的服務是單體式架構 (Monolitch)，服務導向 (SOA)，還是微服務 (Microservice), 最終終究是要開放 API 給別人使用的。
這時最基本的防火牆 (Firewall), 反向代理 (Reverse Proxy), 以及負載平衡 (Load Balancer) 等等我就略過不談了。我們先來談談
API 特有的對外關卡: API Gateway

![](/wp-content/uploads/2017/06/2017-06-07-00-50-18.png)

先來看看實際的使用情境: 假設 Amazon 網站已經微服務化了 (實際上也真的是沒錯)，來想像一下這個 APP 為了實現畫面上的所有功能，
進入這個購物 APP 首頁時，究竟要從後端呼叫多少微服務的 API 才能湊齊這個畫面所需的所有資訊?

按照圖上的標號，分別有:

1. 訂購紀錄: 要從訂購管理的服務 API 取得
1. 商品評價: 評價系統 API
1. 商品資訊: 商品上架管理系統 API
1. 推薦商品: 採購行為與紀錄分析 (big data?)
1. 商品庫存: 庫存管理系統 API
1. 購物車:   訂購流程管理 API

如果這個 APP 真的這樣寫，我看打開 APP 時，轉圈圈至少會轉個半分鐘以上吧。用 fiddler 錄製中間的 http traffic, 會看到好幾條。
微服務要解決的是內部軟體開發架構的維護，擴展等等架構問題，這些對外面的客戶及系統是非必要的。對外界來說，只要把整套系統當成單一應用程式就好了。這時要呼叫這麼多次 API 才能湊齊足夠的資訊，這做法還蠻蠢的...

![](/wp-content/uploads/2017/06/2017-06-07-01-00-44.png)

於是... 開始出現了 API Gateway 這樣的處理模式，額外建立一個 API Gateway, 放在 APP 與 Microservices 之間，用來轉發及合併多次
API 呼叫。APP 只要對 API Gateway 做一次 API call, 由 API Gateway 代勞，到後端各個服務個別取得所需資訊之後，統一匯集起來傳回前端 APP。這麼一來，對於 APP 來說，他只要一次的呼叫就能取得所有的資訊。

當然 API Gateway 不只是做 N => 1 這種事情而已。其他如 API management, API routing, caching, authorization, logging ... 等等
都有可能在 API Gateway 之中一起處理。這兩種模式 (直接呼叫 vs 透過 API Gateway) 有哪些差異? 我列舉幾個最明顯的特徵:

模式  |   直接呼叫    |   透過 API Gateway
------|--------------|--------------------
1. | 效率差，須經過多次往返 | 效率好，只需一次往返
2. | 不易管理，內部服務架構異動會影響 APP 設計 | 好管理，將內部服務架構的細節隔離在內部。必要時也能進行不同版本或格式的 API 轉譯
3. | 難以最佳化 | 有統一的進出端口，容易進行最佳化，API Gateway 能妥善做好 output cache
4. | 安全性差，跨服務的溝通細節暴露在外界 | 安全性佳，不需將不必要的細節傳遞到外面。API Gateway 甚至能負責認證等等問題。

API Gateway 除了單純的替 APP 呼叫後端 API 時做好 reverse proxy 以及 API call aggration 之外，有些架構師甚至這樣應用 API Gateway, 這是我覺得 API Gateway 在架構上最關鍵的一項應用，就是認證。

(找圖)

跨越服務的認證，一直都是件麻煩的事情。在沒有有經驗的架構師的情況下，團隊往往會做出很糟糕的設計: 每個服務都有自己的認證跟授權機制，
A -> B 有一套轉移認證資訊的作法，B -> C 又一套... 有 N 套服務在運作時，就有 N x (N-1) 種組合要處理... 這時 API Gateway 可以額外
跟負責任證的服務整合，所有 request 統一先取得認證資訊之後，再交由 API Gateway 轉發給內部各個服務。由 API Gateway 統一處理認證
失敗，認證過程的 log 等等動作，後端的服務則在安全的保護傘之下，只要憑著 API Gateway 傳過來的憑證，提供 APP 各種服務即可。

其實這部分實作的原理，在這系列的這篇 [API Token] 就已經說明過實作細節了。





## Service Discovery

![](/wp-content/uploads/2017/06/2017-06-07-00-28-21.png)

![](/wp-content/uploads/2017/06/2017-06-07-00-28-31.png)

![](/wp-content/uploads/2017/06/2017-06-07-00-28-41.png)




# Docker, 最佳的微服務部署方式

# Immutable Services

